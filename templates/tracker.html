{% extends 'base.html' %}

{% block body %}
<header class="site-header">
  <div class="page-frame">
    <nav class="site-nav">
      <a href="{{ url_for('home') }}" class="logo">CityU Tracker</a>
      <ul class="nav-links">
        <li><a href="{{ url_for('home') }}" class="{{ 'active' if current == 'home' else '' }}">Home</a></li>
        <li><a href="{{ url_for('tracker') }}" class="{{ 'active' if current == 'tracker' else '' }}">Tracker</a></li>
        <li><a href="{{ url_for('profile') }}" class="{{ 'active' if current == 'profile' else '' }}">Profile</a></li>
        <li><a href="{{ url_for('about') }}" class="{{ 'active' if current == 'about' else '' }}">About</a></li>
        {% if current_user.is_authenticated %}
          <li><a href="{{ url_for('logout') }}">Log Out</a></li>
        {% else %}
          <li><a href="{{ url_for('login') }}" class="{{ 'active' if current == 'login' else '' }}">Log In</a></li>
          <li><a href="{{ url_for('register') }}" class="{{ 'active' if current == 'register' else '' }}">Register</a></li>
        {% endif %}
      </ul>
    </nav>
  </div>
</header>

<main class="site-main">
  <div class="page-frame">

    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="page-title mb-0">Tracker</h2>

      <button type="button"
              class="btn btn-primary"
              data-bs-toggle="modal"
              data-bs-target="#submitModal">
        + Submit Result
      </button>
    </div>

    <h5 class="page-title-submit mb-3">Recent Submissions</h5>

    {% if submissions %}
      <div class="tracker-grid">
        {% for s in submissions %}
          <article class="card status-{{ s.status }}">
            <a href="{{ url_for('submission_detail', id=s.id) }}" class="card-link" aria-label="View submission details"></a>
            <div class="card-header">
              <div>
                <div class="uni-name">{{ s.school }}</div>
                <div class="program-name">{{ s.program }}</div>
              </div>
              <div class="d-flex align-items-end gap-2 card-actions">
                <span class="status-badge">{{ s.status|upper }}</span>
                {% if current_user.is_authenticated and s.user_id == current_user.id %}
                  <div class="dropdown">
                    <button class="dots-button" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Submission actions">
                      &middot;&middot;&middot;
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                      <li><a class="dropdown-item" href="{{ url_for('edit_submission', id=s.id) }}">Update</a></li>
                      <li>
                        <form method="POST" action="{{ url_for('delete', id=s.id) }}" onsubmit="return confirm('Delete this submission?');">
                          <button type="submit" class="dropdown-item text-danger">Delete</button>
                        </form>
                      </li>
                    </ul>
                  </div>
                {% endif %}
              </div>
            </div>

            <div class="stats-container stats-compact">
              <div class="stat-item">
                <span class="stat-label">GPA</span>
                <span class="stat-value">
                  {{ s.gpa if s.gpa is not none else "—" }}
                </span>
              </div>

              <div class="stat-item">
                <span class="stat-label">Tests</span>
                <span class="stat-value">
                  {% if s.gre_total %}
                    GRE {{ s.gre_total }}
                  {% elif s.gmat_total %}
                    GMAT {{ s.gmat_total }}
                  {% else %}
                    —
                  {% endif %}
                </span>
              </div>

              <div class="stat-item">
                <span class="stat-label">English</span>
                <span class="stat-value">
                  {% if s.ielts_total %}
                    IELTS {{ s.ielts_total }}
                  {% elif s.toefl_total %}
                    TOEFL {{ s.toefl_total }}
                  {% else %}
                    —
                  {% endif %}
                </span>
              </div>
            </div>

            <div class="stats-container stats-dates">
              <div class="stat-item">
                <span class="stat-label">Submitted</span>
                <span class="stat-value">
                  {% if s.submission_date %}
                    {{ s.submission_date.strftime("%b %d, %Y") }}
                  {% else %}
                    —
                  {% endif %}
                </span>
              </div>

              <div class="stat-item">
                <span class="stat-label">Result</span>
                <span class="stat-value">
                  {% if s.result_date %}
                    {{ s.result_date.strftime("%b %d, %Y") }}
                  {% else %}
                    —
                  {% endif %}
                </span>
              </div>
            </div>
          </article>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-muted">No submissions yet. Click “+ Submit Result” to add one.</p>
    {% endif %}

  </div>
</main>

<!-- Modal goes OUTSIDE main/page-frame -->
<div class="modal fade" id="submitModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Submit an Application Result</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <form method="POST" class="submit-form">
        {{ form.hidden_tag() }}
          <div class="mb-3">
            {{ form.faculty.label(class="form-label") }}
            {{ form.faculty() }}
            {% for e in form.faculty.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
          </div>

          <div class="mb-3">
            {{ form.school.label(class="form-label") }}
            {{ form.school() }}
            {% for e in form.school.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
          </div>

          <div class="mb-3">
            {{ form.program.label(class="form-label") }}
            {{ form.program() }}
            {% for e in form.program.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
          </div>

          <div class="mb-3">
            {{ form.status.label(class="form-label") }}
            {{ form.status() }}
            {% for e in form.status.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
          </div>

          <div class="mb-3">
            {{ form.region.label(class="form-label") }}
            {{ form.region() }}
            {% for e in form.region.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
          </div>

          <div class="row g-3">
            <div class="col-md-6">
              {{ form.submission_date.label(class="form-label") }}
              {{ form.submission_date(class="form-control") }}
              {% for e in form.submission_date.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
            </div>
            <div class="col-md-6">
              {{ form.result_date.label(class="form-label") }}
              {{ form.result_date(class="form-control") }}
              {% for e in form.result_date.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
            </div>
          </div>

          <div class="form-check mb-4">
            {{ form.is_public(class="form-check-input") }}
            {{ form.is_public.label(class="form-check-label") }}
          </div>

          <hr class="my-4">

          <!-- GPA -->
          <p>
            <a class="btn btn-outline-secondary btn-sm" data-bs-toggle="collapse" href="#collapseGPA" role="button">
              + GPA (optional)
            </a>
          </p>
          <div class="collapse" id="collapseGPA">
            <div class="card card-body">
              <div class="mb-3">
                {{ form.gpa.label(class="form-label") }}
                {{ form.gpa(class="form-control") }}
                {% for e in form.gpa.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
              </div>
            </div>
          </div>

          <!-- GRE / GMAT -->
          <p class="mt-3">
            <a class="btn btn-outline-secondary btn-sm" data-bs-toggle="collapse" href="#collapseTests" role="button">
              + GRE / GMAT (optional)
            </a>
          </p>
          <div class="collapse" id="collapseTests">
            <div class="card card-body">
              <h6 class="mb-2">GRE</h6>
              <div class="row g-2">
                <div class="col-md-6">
                  {{ form.gre_total.label(class="form-label") }}
                  {{ form.gre_total(class="form-control") }}
                </div>
                <div class="col-md-4">
                  {{ form.gre_q.label(class="form-label") }}
                  {{ form.gre_q(class="form-control") }}
                </div>
                <div class="col-md-4">
                  {{ form.gre_v.label(class="form-label") }}
                  {{ form.gre_v(class="form-control") }}
                </div>
                <div class="col-md-4">
                  {{ form.gre_awa.label(class="form-label") }}
                  {{ form.gre_awa(class="form-control") }}
                </div>
          </div>
              {% for e in form.gre_total.errors %}<div class="text-danger small mt-2">{{ e }}</div>{% endfor %}

              <hr class="my-3">

              <h6 class="mb-2">GMAT</h6>
              <div class="row g-2">
                <div class="col-md-6">
                  {{ form.gmat_total.label(class="form-label") }}
                  {{ form.gmat_total(class="form-control") }}
                </div>
                <div class="col-md-4">
                  {{ form.gmat_q.label(class="form-label") }}
                  {{ form.gmat_q(class="form-control") }}
                </div>
                <div class="col-md-4">
                  {{ form.gmat_v.label(class="form-label") }}
                  {{ form.gmat_v(class="form-control") }}
                </div>
                <div class="col-md-4">
                  {{ form.gmat_di.label(class="form-label") }}
                  {{ form.gmat_di(class="form-control") }}
                </div>
              </div>
              {% for e in form.gmat_total.errors %}<div class="text-danger small mt-2">{{ e }}</div>{% endfor %}
            </div>
          </div>

          <!-- IELTS / TOEFL -->
          <p class="mt-3">
            <a class="btn btn-outline-secondary btn-sm" data-bs-toggle="collapse" href="#collapseEnglish" role="button">
              + IELTS / TOEFL (optional)
            </a>
          </p>
          <div class="collapse" id="collapseEnglish">
            <div class="card card-body">

              <h6 class="mb-2">IELTS</h6>
              <div class="mb-2">
                {{ form.ielts_total.label(class="form-label") }}
                {{ form.ielts_total(class="form-control") }}
                {% for e in form.ielts_total.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
              </div>
              <div class="row g-2">
                <div class="col-md-3">{{ form.ielts_l(class="form-control", placeholder="L") }}</div>
                <div class="col-md-3">{{ form.ielts_r(class="form-control", placeholder="R") }}</div>
                <div class="col-md-3">{{ form.ielts_w(class="form-control", placeholder="W") }}</div>
                <div class="col-md-3">{{ form.ielts_s(class="form-control", placeholder="S") }}</div>
              </div>

              <hr class="my-3">

              <h6 class="mb-2">TOEFL</h6>
              <div class="mb-2">
                {{ form.toefl_total.label(class="form-label") }}
                {{ form.toefl_total(class="form-control") }}
                {% for e in form.toefl_total.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
              </div>
              <div class="row g-2">
                <div class="col-md-3">{{ form.toefl_l(class="form-control", placeholder="L") }}</div>
                <div class="col-md-3">{{ form.toefl_r(class="form-control", placeholder="R") }}</div>
                <div class="col-md-3">{{ form.toefl_s(class="form-control", placeholder="S") }}</div>
                <div class="col-md-3">{{ form.toefl_w(class="form-control", placeholder="W") }}</div>
              </div>

            </div>
          </div>

        <div class="mt-4">
          {{ form.submit(class="btn btn-primary w-100") }}
        </div>
      </form>

    </div>
  </div>
</div>
{% endblock %}
